---
title: Bridged or NAT 你也要网上冲浪吗?
date: 2020-05-27 14:20:53
updte: 2020-05-27 14:20:53
categories:
- 工具
tags:
- network
- VM
---
最近公司加了审计网关，每个人限定 MAC ，登录上网。旁边的小伙伴虚拟机就断网了，这可愁坏了小伙子，还能不能愉快的~~划水~~玩耍啦？

俗话说的好，摸鱼乃人生大事。

救救孩子！

那我们这种老油条自然要伸出援助之手。
<!--more-->
这事是怎么回事呢，那就要从桥接和 NAT 两种模式说起。

### Bridged Networking 桥接网络
简单来说就是通过物理机的网卡搭桥。这个桥搭到哪里呢？搭到物理机所在的网络，也就是说通过桥接的方式
虚拟机在物理机所在网络中实实在在占据了一个 IP。所以我们可以和这个网络中的所有设备通信。

这种方式呢就好比我们完美的伪造了一套户口、身份证，这个世上从此多了一个人。


### NAT(Network Address Translation) 网络地址转换
NAT 呢可以理解为一个代理人，我们的所有网络请求都以物理机的身份来提交,外界则感知不到虚拟机的存在。

虚拟机分配到的 IP 呢则是不在物理机网络的网段。

### 解决方法
所以审计网关锁定 MAC，我们以桥接的方式上不了网，但是我们改用 NAT 的方式就可以暗戳戳的用物理机的身份上网了。

当然光配置 NAT 还有一点不足。这种方式我们作为客户端的服务都可以使用了，但是虚拟机作为服务端的应用还是受限的。

原因在于服务端的端口号是指定的。

当我们作为客户端发起请求的时候，虚拟机的操作系统会分配一个随机的端口号，同时 NAT 服务也会在物理机上申请一个端口号，这时 NAT 服务就会把这两个端口号的对应关系记住，虚拟机就可以正常通信了。这个过程中物理机其实是完全感知不到这一切的，这些转换都是我们的虚拟机软件来做的。

正因为物理机对这些东西是没有感知的，所以我们想 ssh 到虚拟机上时就有问题了，我们指定的是物理机的 IP, 22的端口号。
这在物理机看来就是：你小子想和我搞 SSH?  这时不管它答不答应都和虚拟机没关系了。

那我们怎么解决这个问题呢？端口转发就是针对这个啦。

所谓端口转发就是我们告诉 NAT 服务，把物理机的X端口和虚拟机的Y端口关联起来，那么凡是向X端口发起的数据都会转给虚拟机Y端口，Y发出的呢也会转给X。

最后我们来看一下实操。VirtualBox:
1. 设置 NAT
![NAT setting](/post_images/2020-05-27-NAT-or-Bridged/vboxNetSetting.jpg)
2. 配置端口转发
![port forwarding](/post_images/2020-05-27-NAT-or-Bridged/portForwarding.jpg)
主机的 IP 也可以不填，像这里我们指定为 localhost 的话就只能通过这个 IP 访问，不指定的话则主机 DHCP 获取的 IP 和本地回环都是能用的。

一般配个22端口的转发就够了。这里4000是为了方便摸鱼水blog，比如这篇:D
